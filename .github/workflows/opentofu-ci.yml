name: OpenTofu CI

on:
  workflow_call:
    inputs:
      runs_on:
        description: "Runner to use"
        required: false
        default: "ubuntu-latest"
        type: string
      working_directory:
        description: "Working directory for OpenTofu commands"
        required: false
        default: "."
        type: string
      opentofu_version:
        description: "OpenTofu version to use (leave empty for latest)"
        required: false
        default: ""
        type: string
      enable_security_scan:
        description: "Enable security scanning with Checkov and TFSec"
        required: false
        default: false
        type: boolean
      enable_docs:
        description: "Enable automatic documentation generation"
        required: false
        default: false
        type: boolean
      docs_output_file:
        description: "Output file for terraform-docs"
        required: false
        default: "README.md"
        type: string
      allowed_pr_author:
        description: "GitHub username allowed to run on PRs (empty for all)"
        required: false
        default: ""
        type: string
      validate_directory:
        description: "Directory for tofu init/validate (for modules with provider aliases, use tests/)"
        required: false
        default: ""
        type: string

jobs:
  lint:
    name: OpenTofu Lint & Validate
    runs-on: ${{ inputs.runs_on }}
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (
        github.event_name == 'pull_request' &&
        (inputs.allowed_pr_author == '' || github.event.pull_request.user.login == inputs.allowed_pr_author)
      )
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@9d84900f3238fab8cd84ce47d658d25dd008be2f # v1
        with:
          tofu_version: ${{ inputs.opentofu_version || null }}

      - name: OpenTofu Format Check
        run: tofu fmt -check -recursive

      - name: OpenTofu Init
        working-directory: ${{ inputs.validate_directory || inputs.working_directory }}
        run: tofu init -backend=false

      - name: OpenTofu Validate
        working-directory: ${{ inputs.validate_directory || inputs.working_directory }}
        run: tofu validate

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@4cb9feea73331a35b422df102992a03a44a3bb33 # v6

      - name: Init TFLint
        run: tflint --init

      - name: Run TFLint
        run: tflint --recursive

  security:
    name: Security Scanning
    runs-on: ${{ inputs.runs_on }}
    if: |
      inputs.enable_security_scan && (
        github.event_name == 'workflow_dispatch' ||
        github.event_name == 'push' ||
        (
          github.event_name == 'pull_request' &&
          (inputs.allowed_pr_author == '' || github.event.pull_request.user.login == inputs.allowed_pr_author)
        )
      )
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Checkov Security Scan
        uses: bridgecrewio/checkov-action@b3c44b4437c93549fc8cfaef9208497ba4955d39 # v12.3081.0
        with:
          directory: ${{ inputs.working_directory }}
          framework: terraform
          soft_fail: true
          output_format: cli

      - name: Trivy Security Scan
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: config
          scan-ref: ${{ inputs.working_directory }}
          scanners: misconfig,secret
          exit-code: 0
          format: table

  docs:
    name: Documentation
    runs-on: ${{ inputs.runs_on }}
    if: inputs.enable_docs && github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Terraform Docs
        uses: terraform-docs/gh-actions@6de6da0cefcc6b4b7a5cbea4d79d97060733093c # v1.4.1
        with:
          working-dir: ${{ inputs.working_directory }}
          output-file: ${{ inputs.docs_output_file }}
          output-method: inject
          git-push: "true"
