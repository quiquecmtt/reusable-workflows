name: Terraform CI

on:
  workflow_call:
    inputs:
      runs_on:
        description: "Runner to use"
        required: false
        default: "ubuntu-latest"
        type: string
      working_directory:
        description: "Working directory for Terraform commands"
        required: false
        default: "."
        type: string
      terraform_version:
        description: "Terraform version to use (leave empty for latest)"
        required: false
        default: ""
        type: string
      enable_security_scan:
        description: "Enable security scanning with Checkov and TFSec"
        required: false
        default: false
        type: boolean
      enable_docs:
        description: "Enable automatic documentation generation"
        required: false
        default: false
        type: boolean
      docs_output_file:
        description: "Output file for terraform-docs"
        required: false
        default: "README.md"
        type: string
      allowed_pr_author:
        description: "GitHub username allowed to run on PRs (empty for all)"
        required: false
        default: ""
        type: string
      validate_directory:
        description: "Directory for terraform init/validate (for modules with provider aliases, use tests/)"
        required: false
        default: ""
        type: string

jobs:
  lint:
    name: Terraform Lint & Validate
    runs-on: ${{ inputs.runs_on }}
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (
        github.event_name == 'pull_request' &&
        (inputs.allowed_pr_author == '' || github.event.pull_request.user.login == inputs.allowed_pr_author)
      )
    defaults:
      run:
        working-directory: ${{ inputs.working_directory }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_version: ${{ inputs.terraform_version || null }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init
        working-directory: ${{ inputs.validate_directory || inputs.working_directory }}
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: ${{ inputs.validate_directory || inputs.working_directory }}
        run: terraform validate

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@4cb9feea73331a35b422df102992a03a44a3bb33 # v6

      - name: Init TFLint
        run: tflint --init

      - name: Run TFLint
        run: tflint --recursive

  security:
    name: Security Scanning
    runs-on: ${{ inputs.runs_on }}
    if: |
      inputs.enable_security_scan && (
        github.event_name == 'workflow_dispatch' ||
        github.event_name == 'push' ||
        (
          github.event_name == 'pull_request' &&
          (inputs.allowed_pr_author == '' || github.event.pull_request.user.login == inputs.allowed_pr_author)
        )
      )
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Checkov Security Scan
        uses: bridgecrewio/checkov-action@05d9f3cd4807c3dea7444d4e60dc44ad57928ab5 # v12.3084.0
        with:
          directory: ${{ inputs.working_directory }}
          framework: terraform
          soft_fail: true
          output_format: cli

      - name: Trivy Security Scan
        uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284 # 0.34.0
        with:
          scan-type: config
          scan-ref: ${{ inputs.working_directory }}
          scanners: misconfig,secret
          exit-code: 0
          format: table

  docs:
    name: Documentation
    runs-on: ${{ inputs.runs_on }}
    if: inputs.enable_docs && github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Terraform Docs
        uses: terraform-docs/gh-actions@6de6da0cefcc6b4b7a5cbea4d79d97060733093c # v1.4.1
        with:
          working-dir: ${{ inputs.working_directory }}
          output-file: ${{ inputs.docs_output_file }}
          output-method: inject
          git-push: "true"
